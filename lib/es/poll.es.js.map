{"version":3,"file":"poll.es.js","sources":["../../src/utils.js","../../src/poll.js"],"sourcesContent":["export const isObject = (obj) => {\r\n    return typeof obj === 'object'\r\n}\r\n\r\nexport const isFunction = (fnc) => {\r\n    return typeof fnc === 'function'\r\n}\r\n\r\nexport const isNumber = (number) => {\r\n    return typeof number === 'number'\r\n}\r\n\r\nexport const isPromise = (val) => {\r\n    return isObject(val) && isFunction(val.then) && isFunction(val.catch)\r\n}","import { isPromise, isObject, isNumber } from './utils'\r\nclass PollRequest {\r\n    constructor(config = {}) {\r\n        this.queue = new Map() //轮询队列\r\n        this.configs = new Map() //缓存轮询参数\r\n        if (!this.checkConfig(config)) return\r\n        this.default = Object.assign({\r\n            time: 5000,\r\n            number: null,//总共需要请求次数，默认无限\r\n            delay: 2,//错误情况时的延迟倍数\r\n        }, config, { arg: null })\r\n\r\n        this.key = 0\r\n        this.recKey = [] //key值回收\r\n    }\r\n\r\n    getKey() {\r\n        if (this.recKey.length) {\r\n            return this.recKey.shift()\r\n        }\r\n        return this.key++\r\n    }\r\n\r\n    checkConfig(config) {\r\n        if (isObject(config)) return true\r\n        throw new Error('config must is Object')\r\n        return false\r\n    }\r\n\r\n    push(req, config = {}) {\r\n        if (!this.checkConfig(config)) return\r\n        const key = this.getKey()\r\n        //相同key不在重复添加\r\n        if (this.queue.get(key)) return\r\n        //使用key作为唯一标识\r\n        this.queue.set(key, req)\r\n        this.configs.set(key, Object.assign({ currentNumber: 0 }, this.default, config))\r\n        this.pollStart(key)\r\n        return key\r\n    }\r\n\r\n    pollStart(key) {\r\n        this.requsetSend(key)\r\n    }\r\n\r\n    requsetSend(key) {\r\n        //数据不存在则结束轮询\r\n        const req = this.queue.get(key)\r\n        if (!req) return\r\n\r\n        //获取缓存的配置\r\n        const config = this.configs.get(key) || this.default\r\n\r\n        //检测是否超次\r\n        if (isNumber(config.number) && config.currentNumber >= config.number) {\r\n            return this.remove(key)\r\n        }\r\n\r\n        //直接调用并传参\r\n        const result = req(config.arg || null)\r\n        //记录调用次数\r\n        config.currentNumber += 1\r\n\r\n\r\n        //根据轮询函数的不同类型进行处理\r\n        if (isPromise(result)) {\r\n            result.then(() => {\r\n                this.sendAgain(key, config.time)\r\n            }).catch(() => {\r\n                {\r\n                    //出错时延长轮询时间，保证一定的体验\r\n                    this.sendAgain(key, config.time * config.delay)\r\n                }\r\n            })\r\n        } else {\r\n            this.sendAgain(key, config.time)\r\n        }\r\n    }\r\n\r\n    //轮询调用\r\n    sendAgain(key, time) {\r\n        setTimeout(() => {\r\n            this.requsetSend(key)\r\n        }, time)\r\n    }\r\n\r\n    //移除一个轮询\r\n    remove(key) {\r\n        const has = this.queue.get(key)\r\n        if (!has) return\r\n        this.queue.delete(key)\r\n        this.configs.delete(key)\r\n        this.recKey.push(key)\r\n    }\r\n\r\n    //重置整个轮询器\r\n    clear() {\r\n        this.queue.clear()\r\n        this.configs.clear()\r\n        this.recKey = []\r\n        this.key = 0\r\n    }\r\n\r\n    //当前获取轮询信息，已结束的信息将销毁\r\n    getPollInfo(key) {\r\n        return this.configs.get(key) || null\r\n    }\r\n}\r\n\r\n\r\n\r\nconst createPoll = (function () {\r\n    let tempPollRequest = null\r\n    return function (config = {}) {\r\n        if (tempPollRequest) return tempPollRequest\r\n        tempPollRequest = new PollRequest(config)\r\n        return tempPollRequest\r\n    }\r\n})()\r\n\r\n\r\nexport default createPoll"],"names":["const","this","let"],"mappings":"AAAOA,IAAM,QAAQ,aAAI,GAAG,EAAK;AACjC,IAAI,OAAO,OAAO,GAAG,KAAK,QAAQ;AAClC,EAAC;AACD;AACOA,IAAM,UAAU,aAAI,GAAG,EAAK;AACnC,IAAI,OAAO,OAAO,GAAG,KAAK,UAAU;AACpC,EAAC;AACD;AACOA,IAAM,QAAQ,aAAI,MAAM,EAAK;AACpC,IAAI,OAAO,OAAO,MAAM,KAAK,QAAQ;AACrC,EAAC;AACD;AACOA,IAAM,SAAS,aAAI,GAAG,EAAK;AAClC,IAAI,OAAO,QAAQ,CAAC,GAAG,CAAC,IAAI,UAAU,CAAC,GAAG,CAAC,IAAI,CAAC,IAAI,UAAU,CAAC,GAAG,CAAC,KAAK,CAAC;AACzE;;ACbA,IAAM,WAAW,GACb,oBAAW,CAAC,MAAW,EAAE;mCAAP,GAAG;AAAK;AAC9B,IAAQ,IAAI,CAAC,KAAK,GAAG,IAAI,GAAG,GAAE;AAC9B,IAAQ,IAAI,CAAC,OAAO,GAAG,IAAI,GAAG,GAAE;AAChC,IAAQ,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,IAAE,QAAM;AAC7C,IAAQ,IAAI,CAAC,OAAO,GAAG,MAAM,CAAC,MAAM,CAAC;AACrC,QAAY,IAAI,EAAE,IAAI;AACtB,QAAY,MAAM,EAAE,IAAI;AACxB,QAAY,KAAK,EAAE,CAAC;AACpB,KAAS,EAAE,MAAM,EAAE,EAAE,GAAG,EAAE,IAAI,EAAE,EAAC;AACjC;AACA,IAAQ,IAAI,CAAC,GAAG,GAAG,EAAC;AACpB,IAAQ,IAAI,CAAC,MAAM,GAAG,GAAE;AACpB,EAAC;AACL;sBACI,4BAAS;AACb,IAAQ,IAAI,IAAI,CAAC,MAAM,CAAC,MAAM,EAAE;AAChC,QAAY,OAAO,IAAI,CAAC,MAAM,CAAC,KAAK,EAAE;AACtC,KAAS;AACT,IAAQ,OAAO,IAAI,CAAC,GAAG,EAAE;AACrB,EAAC;AACL;sBACI,oCAAY,MAAM,EAAE;AACxB,IAAQ,IAAI,QAAQ,CAAC,MAAM,CAAC,IAAE,OAAO,MAAI;AACzC,IAAQ,MAAM,IAAI,KAAK,CAAC,uBAAuB,CAAC;AAE5C,EAAC;AACL;sBACI,sBAAK,GAAG,EAAE,MAAW,EAAE;uCAAP,GAAG;AAAK;AAC5B,IAAQ,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,IAAE,QAAM;AAC7C,IAAQA,IAAM,GAAG,GAAG,IAAI,CAAC,MAAM,GAAE;AACjC;AACA,IAAQ,IAAI,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,GAAG,CAAC,IAAE,QAAM;AACvC;AACA,IAAQ,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,GAAG,EAAE,GAAG,EAAC;AAChC,IAAQ,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,GAAG,EAAE,MAAM,CAAC,MAAM,CAAC,EAAE,aAAa,EAAE,CAAC,EAAE,EAAE,IAAI,CAAC,OAAO,EAAE,MAAM,CAAC,EAAC;AACxF,IAAQ,IAAI,CAAC,SAAS,CAAC,GAAG,EAAC;AAC3B,IAAQ,OAAO,GAAG;AACd,EAAC;AACL;sBACI,gCAAU,GAAG,EAAE;AACnB,IAAQ,IAAI,CAAC,WAAW,CAAC,GAAG,EAAC;AACzB,EAAC;AACL;sBACI,oCAAY,GAAG,EAAE;;AAAC;AACtB;AACA,IAAQA,IAAM,GAAG,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,GAAG,EAAC;AACvC,IAAQ,IAAI,CAAC,GAAG,IAAE,QAAM;AACxB;AACA;AACA,IAAQA,IAAM,MAAM,GAAG,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,IAAI,IAAI,CAAC,QAAO;AAC5D;AACA;AACA,IAAQ,IAAI,QAAQ,CAAC,MAAM,CAAC,MAAM,CAAC,IAAI,MAAM,CAAC,aAAa,IAAI,MAAM,CAAC,MAAM,EAAE;AAC9E,QAAY,OAAO,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC;AACnC,KAAS;AACT;AACA;AACA,IAAQA,IAAM,MAAM,GAAG,GAAG,CAAC,MAAM,CAAC,GAAG,IAAI,IAAI,EAAC;AAC9C;AACA,IAAQ,MAAM,CAAC,aAAa,IAAI,EAAC;AACjC;AACA;AACA;AACA,IAAQ,IAAI,SAAS,CAAC,MAAM,CAAC,EAAE;AAC/B,QAAY,MAAM,CAAC,IAAI,aAAO;AAC9B,YAAgBC,QAAI,CAAC,SAAS,CAAC,GAAG,EAAE,MAAM,CAAC,IAAI,EAAC;AAChD,SAAa,CAAC,CAAC,KAAK,aAAO;AAC3B,YAAgB;AAChB;AACA,gBAAoBA,QAAI,CAAC,SAAS,CAAC,GAAG,EAAE,MAAM,CAAC,IAAI,GAAG,MAAM,CAAC,KAAK,EAAC;AACnE,aAAiB;AACjB,SAAa,EAAC;AACd,KAAS,MAAM;AACf,QAAY,IAAI,CAAC,SAAS,CAAC,GAAG,EAAE,MAAM,CAAC,IAAI,EAAC;AAC5C,KAAS;AACL,EAAC;AACL;AACI;sBACA,gCAAU,GAAG,EAAE,IAAI,EAAE;;AAAC;AAC1B,IAAQ,UAAU,aAAO;AACzB,QAAYA,QAAI,CAAC,WAAW,CAAC,GAAG,EAAC;AACjC,KAAS,EAAE,IAAI,EAAC;AACZ,EAAC;AACL;AACI;sBACA,0BAAO,GAAG,EAAE;AAChB,IAAQD,IAAM,GAAG,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,GAAG,EAAC;AACvC,IAAQ,IAAI,CAAC,GAAG,IAAE,QAAM;AACxB,IAAQ,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,GAAG,EAAC;AAC9B,IAAQ,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,GAAG,EAAC;AAChC,IAAQ,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,EAAC;AACzB,EAAC;AACL;AACI;sBACA,0BAAQ;AACZ,IAAQ,IAAI,CAAC,KAAK,CAAC,KAAK,GAAE;AAC1B,IAAQ,IAAI,CAAC,OAAO,CAAC,KAAK,GAAE;AAC5B,IAAQ,IAAI,CAAC,MAAM,GAAG,GAAE;AACxB,IAAQ,IAAI,CAAC,GAAG,GAAG,EAAC;AAChB,EAAC;AACL;AACI;sBACA,oCAAY,GAAG,EAAE;AACrB,IAAQ,OAAO,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,IAAI,IAAI;AACxC,EACH;AACD;AACA;AACA;AACK,IAAC,UAAU,GAAG,CAAC,YAAY;AAChC,IAAIE,IAAI,eAAe,GAAG,KAAI;AAC9B,IAAI,OAAO,UAAU,MAAW,EAAE;uCAAP,GAAG;AAAK;AACnC,QAAQ,IAAI,eAAe,IAAE,OAAO,iBAAe;AACnD,QAAQ,eAAe,GAAG,IAAI,WAAW,CAAC,MAAM,EAAC;AACjD,QAAQ,OAAO,eAAe;AAC9B,KAAK;AACL,CAAC;;;;"}